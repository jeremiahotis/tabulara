{
  "success": true,
  "subprocess": "atdd-api-tests",
  "tests": [
    {
      "file": "tests/api/story-1-5-run-extraction-and-persist-derived-data-updates.spec.ts",
      "content": "import { test, expect, type APIRequestContext } from '@playwright/test';\n\ntype DispatchResponse = {\n  accepted?: boolean;\n  command_id?: string;\n  mutation_applied?: boolean;\n  event_appended?: boolean;\n  extraction_outputs?: {\n    tokens?: Array<Record<string, unknown>>;\n    lines?: Array<Record<string, unknown>>;\n    table_candidates?: Array<Record<string, unknown>>;\n    derived_values?: Array<Record<string, unknown>>;\n  };\n  events?: Array<{\n    type?: string;\n    caused_by?: string;\n    data?: Record<string, unknown>;\n  }>;\n  error?: {\n    code?: string;\n    details?: Array<{\n      field?: string;\n      reason?: string;\n    }>;\n  };\n};\n\nasync function dispatchCommand(request: APIRequestContext, command: Record<string, unknown>) {\n  return request.post('/api/v1/commands/dispatch', { data: command });\n}\n\nfunction createRunExtractionCommand(overrides: Partial<Record<string, unknown>> = {}) {\n  return {\n    command_id: crypto.randomUUID(),\n    type: 'RunExtraction',\n    actor: {\n      id: 'ops-test-user',\n      role: 'ops-user',\n    },\n    timestamp: new Date().toISOString(),\n    payload: {\n      session_id: 'session-extract-default',\n      document_id: 'missing-document-id',\n      extraction_profile: 'default-v1',\n      source_state: 'preprocess-ready',\n      ...overrides,\n    },\n  };\n}\n\ntest.describe('Story 1.5 run extraction and persist derived data updates (ATDD RED)', () => {\n  test.skip(\n    '[P0][AC1] should persist extraction outputs and derived values transactionally when RunExtraction succeeds',\n    async ({ request }) => {\n      const command = createRunExtractionCommand({\n        session_id: `session-extract-${crypto.randomUUID()}`,\n        document_id: `document-ready-${crypto.randomUUID()}`,\n        extraction_profile: 'operations-default',\n      });\n\n      const response = await dispatchCommand(request, command);\n\n      expect(response.status()).toBe(202);\n      const body = (await response.json()) as DispatchResponse;\n      expect(body).toMatchObject({\n        accepted: true,\n        command_id: command.command_id,\n        mutation_applied: true,\n        event_appended: true,\n        extraction_outputs: {\n          tokens: expect.any(Array),\n          lines: expect.any(Array),\n          table_candidates: expect.any(Array),\n          derived_values: expect.any(Array),\n        },\n      });\n    },\n  );\n\n  test.skip(\n    '[P0][AC1] should append ExtractionCompleted and derived-data events with command linkage',\n    async ({ request }) => {\n      const command = createRunExtractionCommand({\n        session_id: `session-extract-${crypto.randomUUID()}`,\n        document_id: `document-ready-${crypto.randomUUID()}`,\n      });\n\n      const response = await dispatchCommand(request, command);\n\n      expect(response.status()).toBe(202);\n      const body = (await response.json()) as DispatchResponse;\n      expect(body.events).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            type: 'ExtractionCompleted',\n            caused_by: command.command_id,\n            data: expect.objectContaining({\n              session_id: expect.any(String),\n              document_id: expect.any(String),\n            }),\n          }),\n          expect.objectContaining({\n            type: 'DerivedDataUpdated',\n            caused_by: command.command_id,\n          }),\n        ]),\n      );\n    },\n  );\n\n  test.skip(\n    '[P0][AC2] should rollback mutation and event append when extraction fails before completion',\n    async ({ request }) => {\n      const command = createRunExtractionCommand({\n        session_id: `session-extract-${crypto.randomUUID()}`,\n        document_id: `document-ready-${crypto.randomUUID()}`,\n        force_fail_stage: 'persistence-before-commit',\n      });\n\n      const response = await dispatchCommand(request, command);\n\n      expect(response.status()).toBe(409);\n      const body = (await response.json()) as DispatchResponse;\n      expect(body).toMatchObject({\n        mutation_applied: false,\n        event_appended: false,\n        error: {\n          code: 'PRECONDITION_FAILED',\n          details: expect.arrayContaining([\n            expect.objectContaining({\n              field: 'run_extraction',\n              reason: 'transaction_rolled_back',\n            }),\n          ]),\n        },\n      });\n    },\n  );\n\n  test.skip(\n    '[P0][AC2] should return deterministic failure payload for UI handling on extraction pipeline errors',\n    async ({ request }) => {\n      const command = createRunExtractionCommand({\n        session_id: 'session-deterministic-failure',\n        document_id: 'document-deterministic-failure',\n        force_fail_stage: 'extractor-runtime',\n      });\n\n      const response = await dispatchCommand(request, command);\n\n      expect(response.status()).toBe(409);\n      const body = (await response.json()) as DispatchResponse;\n      expect(body).toMatchObject({\n        mutation_applied: false,\n        event_appended: false,\n        error: {\n          code: 'EXTRACTION_FAILED',\n          details: expect.arrayContaining([\n            expect.objectContaining({\n              field: 'pipeline',\n              reason: 'extractor_runtime_error',\n            }),\n          ]),\n        },\n      });\n    },\n  );\n\n  test.skip('[P1][AC1] should persist deterministic extraction output structure for downstream verification', async ({ request }) => {\n    const command = createRunExtractionCommand({\n      session_id: `session-extract-${crypto.randomUUID()}`,\n      document_id: `document-ready-${crypto.randomUUID()}`,\n    });\n\n    const response = await dispatchCommand(request, command);\n\n    expect(response.status()).toBe(202);\n    const body = (await response.json()) as DispatchResponse;\n    expect(body.extraction_outputs).toMatchObject({\n      tokens: expect.arrayContaining([expect.objectContaining({ token: expect.any(String) })]),\n      lines: expect.arrayContaining([expect.objectContaining({ line_number: expect.any(Number) })]),\n      table_candidates: expect.any(Array),\n      derived_values: expect.arrayContaining([\n        expect.objectContaining({\n          field: expect.any(String),\n          value: expect.anything(),\n        }),\n      ]),\n    });\n  });\n\n  test.skip(\n    '[P1][AC2] should keep failure envelope deterministic for repeated invalid extraction requests',\n    async ({ request }) => {\n      const command = createRunExtractionCommand({\n        session_id: 'session-repeatable-error',\n        document_id: 'document-missing',\n      });\n\n      const first = await dispatchCommand(request, command);\n      const second = await dispatchCommand(request, command);\n\n      expect(first.status()).toBe(409);\n      expect(second.status()).toBe(409);\n\n      const firstBody = (await first.json()) as DispatchResponse;\n      const secondBody = (await second.json()) as DispatchResponse;\n\n      expect(firstBody.error?.code).toBe('PRECONDITION_FAILED');\n      expect(secondBody.error?.code).toBe('PRECONDITION_FAILED');\n      expect(firstBody.error?.details?.[0]?.reason).toBe(secondBody.error?.details?.[0]?.reason);\n    },\n  );\n});\n",
      "description": "ATDD API tests for story 1.5 extraction persistence (RED PHASE)",
      "expected_to_fail": true,
      "acceptance_criteria_covered": [
        "RunExtraction persists outputs and derived values transactionally",
        "ExtractionCompleted and derived-data events are appended with command linkage",
        "Rollback occurs on extraction failure before completion",
        "Failure payloads are deterministic for UI handling"
      ],
      "priority_coverage": {
        "P0": 4,
        "P1": 2,
        "P2": 0,
        "P3": 0
      }
    }
  ],
  "fixture_needs": [
    "runExtractionCommandFactory",
    "extractionFailurePayloadFixture"
  ],
  "knowledge_fragments_used": [
    "api-request",
    "data-factories",
    "api-testing-patterns"
  ],
  "test_count": 6,
  "tdd_phase": "RED",
  "summary": "Generated 6 FAILING API tests for story 1.5"
}
