{
  "success": true,
  "subprocess": "atdd-e2e-tests",
  "tests": [
    {
      "file": "tests/e2e/story-1-4-apply-preprocessing-and-controlled-reprocessing.spec.ts",
      "content": "import { test, expect, type Page } from '@playwright/test';\n\nasync function dispatchImportForSession(page: Page, sessionId: string, blobIds: string) {\n  const importResponse = page.waitForResponse(\n    (response) =>\n      response.url().includes('/api/v1/commands/dispatch') &&\n      response.request().method() === 'POST' &&\n      response.status() === 202,\n  );\n\n  await page.getByTestId('command-type-input').fill('ImportDocument');\n  await page.getByTestId('import-session-id-input').fill(sessionId);\n  await page.getByTestId('import-blob-ids-input').fill(blobIds);\n  await page.getByTestId('import-metadata-source-input').fill('import');\n  await page.getByTestId('import-file-name-input').fill('story-1-4-seed.pdf');\n  await page.getByTestId('command-submit-button').click();\n  await importResponse;\n}\n\ntest.describe('Story 1.4 preprocessing and controlled reprocessing workflow (ATDD RED)', () => {\n  test.skip(\n    '[P0][AC1] should run ApplyPreprocessing and surface derived artifact linkage plus PreprocessingApplied evidence',\n    async ({ page }) => {\n      await page.goto('/');\n      const sessionId = 'session-preprocess-e2e-001';\n      await dispatchImportForSession(page, sessionId, 'blob-pre-001');\n\n      const preprocessingResponse = page.waitForResponse(\n        (response) =>\n          response.url().includes('/api/v1/commands/dispatch') &&\n          response.request().method() === 'POST' &&\n          response.status() === 202,\n      );\n\n      await page.getByTestId('command-type-input').fill('ApplyPreprocessing');\n      await page.getByTestId('preprocessing-session-id-input').fill(sessionId);\n      await page\n        .getByTestId('preprocessing-document-id-input')\n        .fill(sessionId + ':blob-pre-001');\n      await page.getByTestId('preprocessing-page-ids-input').fill('page-1,page-2');\n      await page.getByTestId('preprocessing-profile-input').fill('ocr-enhance');\n      await page.getByTestId('command-submit-button').click();\n\n      await preprocessingResponse;\n\n      await expect(page.getByTestId('mutation-state')).toHaveText('applied');\n      await expect(page.getByTestId('event-append-state')).toHaveText('appended');\n      await expect(page.getByTestId('audit-event-type-latest')).toHaveText('PreprocessingApplied');\n      await expect(page.getByTestId('derived-artifact-source-page-latest')).toHaveText('page-1');\n      await expect(page.getByTestId('derived-artifact-source-document-latest')).toHaveText(\n        sessionId + ':blob-pre-001',\n      );\n    },\n  );\n\n  test.skip('[P1][AC1] should reject ApplyPreprocessing for missing documents with stable operator-visible error details', async ({ page }) => {\n    await page.goto('/');\n\n    const failedPreprocessResponse = page.waitForResponse(\n      (response) =>\n        response.url().includes('/api/v1/commands/dispatch') &&\n        response.request().method() === 'POST' &&\n        response.status() === 409,\n    );\n\n    await page.getByTestId('command-type-input').fill('ApplyPreprocessing');\n    await page.getByTestId('preprocessing-session-id-input').fill('session-missing-001');\n    await page\n      .getByTestId('preprocessing-document-id-input')\n      .fill('session-missing-001:missing-document-001');\n    await page.getByTestId('preprocessing-page-ids-input').fill('page-1');\n    await page.getByTestId('preprocessing-profile-input').fill('ocr-enhance');\n    await page.getByTestId('command-submit-button').click();\n\n    await failedPreprocessResponse;\n\n    await expect(page.getByTestId('mutation-state')).toHaveText('not-applied');\n    await expect(page.getByTestId('event-append-state')).toHaveText('not-appended');\n    await expect(page.getByTestId('command-error-code')).toHaveText('PRECONDITION_FAILED');\n    await expect(page.getByTestId('command-error-detail-latest')).toHaveText('document_not_found');\n  });\n\n  test.skip(\n    '[P0][AC2] should allow ReprocessDocument on permitted transitions and append DocumentReprocessed while preserving prior audit evidence',\n    async ({ page }) => {\n      await page.goto('/');\n      const sessionId = 'session-reprocess-e2e-001';\n      await dispatchImportForSession(page, sessionId, 'blob-reprocess-001');\n\n      const applyResponse = page.waitForResponse(\n        (response) =>\n          response.url().includes('/api/v1/commands/dispatch') &&\n          response.request().method() === 'POST' &&\n          response.status() === 202,\n      );\n\n      await page.getByTestId('command-type-input').fill('ApplyPreprocessing');\n      await page.getByTestId('preprocessing-session-id-input').fill(sessionId);\n      await page\n        .getByTestId('preprocessing-document-id-input')\n        .fill(sessionId + ':blob-reprocess-001');\n      await page.getByTestId('preprocessing-page-ids-input').fill('page-1');\n      await page.getByTestId('preprocessing-profile-input').fill('ocr-enhance');\n      await page.getByTestId('command-submit-button').click();\n      await applyResponse;\n\n      const reprocessResponse = page.waitForResponse(\n        (response) =>\n          response.url().includes('/api/v1/commands/dispatch') &&\n          response.request().method() === 'POST' &&\n          response.status() === 202,\n      );\n\n      await page.getByTestId('command-type-input').fill('ReprocessDocument');\n      await page.getByTestId('reprocess-session-id-input').fill(sessionId);\n      await page.getByTestId('reprocess-document-id-input').fill(sessionId + ':blob-reprocess-001');\n      await page.getByTestId('reprocess-target-state-input').fill('reprocessed');\n      await page.getByTestId('reprocess-reason-input').fill('operator_requested_quality_upgrade');\n      await page.getByTestId('command-submit-button').click();\n\n      await reprocessResponse;\n\n      await expect(page.getByTestId('mutation-state')).toHaveText('applied');\n      await expect(page.getByTestId('event-append-state')).toHaveText('appended');\n      await expect(page.getByTestId('audit-event-type-latest')).toHaveText('DocumentReprocessed');\n      await expect(page.getByTestId('audit-history-preserved')).toHaveText('true');\n    },\n  );\n\n  test.skip('[P0][AC2] should block disallowed lifecycle transitions with deterministic transition guard errors', async ({ page }) => {\n    await page.goto('/');\n    const sessionId = 'session-reprocess-e2e-002';\n    await dispatchImportForSession(page, sessionId, 'blob-reprocess-002');\n\n    const rejectedReprocessResponse = page.waitForResponse(\n      (response) =>\n        response.url().includes('/api/v1/commands/dispatch') &&\n        response.request().method() === 'POST' &&\n        response.status() === 409,\n    );\n\n    await page.getByTestId('command-type-input').fill('ReprocessDocument');\n    await page.getByTestId('reprocess-session-id-input').fill(sessionId);\n    await page.getByTestId('reprocess-document-id-input').fill(sessionId + ':blob-reprocess-002');\n    await page.getByTestId('reprocess-target-state-input').fill('archived');\n    await page.getByTestId('reprocess-reason-input').fill('operator_requested_quality_upgrade');\n    await page.getByTestId('command-submit-button').click();\n\n    await rejectedReprocessResponse;\n\n    await expect(page.getByTestId('mutation-state')).toHaveText('not-applied');\n    await expect(page.getByTestId('event-append-state')).toHaveText('not-appended');\n    await expect(page.getByTestId('command-error-code')).toHaveText('PRECONDITION_FAILED');\n    await expect(page.getByTestId('command-error-detail-latest')).toHaveText('transition_not_allowed');\n  });\n});\n",
      "description": "ATDD E2E tests for preprocessing and controlled reprocessing journey (RED PHASE)",
      "expected_to_fail": true,
      "acceptance_criteria_covered": [
        "Operator can run ApplyPreprocessing from command workflow",
        "Operator sees transactional append state and PreprocessingApplied evidence",
        "Operator can run ReprocessDocument for permitted transitions",
        "Operator sees deterministic rejection for disallowed transitions"
      ],
      "priority_coverage": {
        "P0": 3,
        "P1": 1,
        "P2": 0,
        "P3": 0
      }
    }
  ],
  "fixture_needs": [
    "story14CommandFormSelectorMap",
    "story14ReprocessUiSeedFixture"
  ],
  "knowledge_fragments_used": [
    "fixture-architecture",
    "network-first",
    "selector-resilience"
  ],
  "test_count": 4,
  "tdd_phase": "RED",
  "summary": "Generated 4 FAILING E2E tests for Story 1.4 preprocessing and controlled reprocessing"
}
