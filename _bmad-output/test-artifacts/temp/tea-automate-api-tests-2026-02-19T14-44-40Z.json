{
  "success": true,
  "subprocess": "api-tests",
  "tests": [
    {
      "file": "tests/api/story-1-5-run-extraction-and-persist-derived-data-updates.automation.spec.ts",
      "content": "import { test, expect } from '../support/fixtures';\nimport { createRunExtractionCommandEnvelope } from '../support/fixtures/factories/extraction-command-factory';\nimport { story15ExpectedErrorCodes, story15RedPhaseData } from '../support/fixtures/story-1-5-red-phase-data';\n\ntest.describe('Story 1.5 API automation coverage', () => {\n  test('[P0][AC1] should reject RunExtraction as unsupported and keep mutation/event side effects disabled', async ({\n    apiRequest,\n  }) => {\n    const command = createRunExtractionCommandEnvelope({\n      payload: {\n        session_id: 'session-story-1-5-api-run',\n        document_id: 'session-story-1-5-api-run:doc-001',\n      },\n    });\n\n    const { status, body } = await apiRequest<{\n      error: {\n        code: string;\n        category: string;\n        details: Array<{ field: string; reason: string }>;\n        allowed_types: string[];\n      };\n      mutation_applied: boolean;\n      event_appended: boolean;\n    }>({\n      method: 'POST',\n      path: '/api/v1/commands/dispatch',\n      body: command,\n    });\n\n    expect(status).toBe(400);\n    expect(body).toMatchObject({\n      error: {\n        code: story15ExpectedErrorCodes.unsupportedType,\n        category: 'validation',\n      },\n      mutation_applied: false,\n      event_appended: false,\n    });\n    expect(body.error.details).toEqual(\n      expect.arrayContaining([\n        expect.objectContaining({\n          field: 'type',\n          reason: story15ExpectedErrorCodes.unsupportedReason,\n        }),\n      ]),\n    );\n    expect(body.error.allowed_types).toEqual(\n      expect.arrayContaining([\n        'CreateSession',\n        'PinSession',\n        'ImportDocument',\n        'ConfirmDuplicate',\n        'ApplyPreprocessing',\n        'ReprocessDocument',\n      ]),\n    );\n  });\n\n  test('[P0][AC2] should return deterministic unsupported-command payloads for repeated RunExtraction dispatches', async ({\n    apiRequest,\n  }) => {\n    const command = createRunExtractionCommandEnvelope({\n      payload: {\n        session_id: 'session-story-1-5-api-repeat',\n        document_id: 'session-story-1-5-api-repeat:doc-001',\n      },\n    });\n\n    const first = await apiRequest<{\n      error: {\n        code: string;\n        details: Array<{ field: string; reason: string }>;\n      };\n      mutation_applied: boolean;\n      event_appended: boolean;\n    }>({\n      method: 'POST',\n      path: '/api/v1/commands/dispatch',\n      body: command,\n    });\n    const second = await apiRequest<{\n      error: {\n        code: string;\n        details: Array<{ field: string; reason: string }>;\n      };\n      mutation_applied: boolean;\n      event_appended: boolean;\n    }>({\n      method: 'POST',\n      path: '/api/v1/commands/dispatch',\n      body: command,\n    });\n\n    expect(first.status).toBe(400);\n    expect(second.status).toBe(400);\n    expect(first.body.error.code).toBe(story15ExpectedErrorCodes.unsupportedType);\n    expect(second.body.error.code).toBe(story15ExpectedErrorCodes.unsupportedType);\n    expect(first.body.error.details[0]).toMatchObject({\n      field: 'type',\n      reason: story15ExpectedErrorCodes.unsupportedReason,\n    });\n    expect(second.body.error.details[0]).toMatchObject({\n      field: 'type',\n      reason: story15ExpectedErrorCodes.unsupportedReason,\n    });\n    expect(first.body.mutation_applied).toBe(false);\n    expect(second.body.mutation_applied).toBe(false);\n    expect(first.body.event_appended).toBe(false);\n    expect(second.body.event_appended).toBe(false);\n  });\n\n  test('[P1][AC1] should generate deterministic RunExtraction envelope defaults with preprocess-ready source metadata', async () => {\n    const command = createRunExtractionCommandEnvelope({\n      payload: {\n        session_id: 'session-story-1-5-factory',\n        document_id: 'session-story-1-5-factory:doc-001',\n      },\n    });\n\n    expect(command.type).toBe(story15RedPhaseData.runExtraction.commandType);\n    expect(command.command_id).toMatch(\n      /^[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,\n    );\n    expect(command.payload).toMatchObject({\n      session_id: 'session-story-1-5-factory',\n      document_id: 'session-story-1-5-factory:doc-001',\n      extraction_profile: story15RedPhaseData.runExtraction.extractionProfile,\n      source_state: story15RedPhaseData.runExtraction.sourceState,\n    });\n  });\n\n  test('[P1][AC2] should allow deterministic force-fail-stage overrides in RunExtraction envelopes for future failure-path expansion', async () => {\n    const command = createRunExtractionCommandEnvelope({\n      payload: {\n        session_id: 'session-story-1-5-force-fail',\n        document_id: 'session-story-1-5-force-fail:doc-001',\n        force_fail_stage: 'extractor-runtime',\n      },\n    });\n\n    expect(command.type).toBe('RunExtraction');\n    expect(command.payload).toMatchObject({\n      session_id: 'session-story-1-5-force-fail',\n      document_id: 'session-story-1-5-force-fail:doc-001',\n      extraction_profile: 'operations-default',\n      source_state: 'preprocess-ready',\n      force_fail_stage: 'extractor-runtime',\n    });\n  });\n});\n",
      "description": "Story 1.5 API automation for deterministic RunExtraction unsupported-command guardrails and extraction envelope defaults",
      "priority_coverage": {
        "P0": 2,
        "P1": 2,
        "P2": 0,
        "P3": 0
      }
    }
  ],
  "fixture_needs": ["extractionCommandFactory", "story15RedPhaseData"],
  "knowledge_fragments_used": ["api-request", "data-factories", "api-testing-patterns", "test-priorities-matrix", "test-quality"],
  "test_count": 4,
  "summary": "Generated 4 API automation tests for Story 1.5 current-state deterministic coverage"
}
