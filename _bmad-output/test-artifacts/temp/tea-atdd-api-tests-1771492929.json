{
  "success": true,
  "subprocess": "atdd-api-tests",
  "tests": [
    {
      "file": "tests/api/story-1-3-import-documents-with-duplicate-handling.spec.ts",
      "content": "import { test, expect } from '@playwright/test';\nimport {\n  createImportDocumentCommandEnvelope,\n  createConfirmDuplicateCommandEnvelope,\n} from '../support/fixtures/factories/document-import-command-factory';\n\ntest.describe('Story 1.3 import + duplicate command handlers (ATDD RED)', () => {\n  test.skip(\n    '[P0][AC1] should persist import metadata and blob references through ImportDocument command handlers',\n    async ({ request }) => {\n      const command = createImportDocumentCommandEnvelope();\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body).toMatchObject({\n        accepted: true,\n        command_id: command.command_id,\n        mutation_applied: true,\n        event_appended: true,\n        session: expect.objectContaining({\n          id: command.payload.session_id,\n        }),\n        documents: expect.arrayContaining([\n          expect.objectContaining({\n            blob_id: command.payload.blob_ids[0],\n            metadata: expect.objectContaining({\n              source: command.payload.metadata.source,\n              file_name: command.payload.metadata.file_name,\n              mime_type: command.payload.metadata.mime_type,\n            }),\n          }),\n        ]),\n      });\n    },\n  );\n\n  test.skip(\n    '[P0][AC1] should append DocumentImported with deterministic caused_by linkage',\n    async ({ request }) => {\n      const command = createImportDocumentCommandEnvelope();\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body.events).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            type: 'DocumentImported',\n            caused_by: command.command_id,\n            data: expect.objectContaining({\n              session_id: command.payload.session_id,\n              blob_ids: command.payload.blob_ids,\n              metadata: expect.objectContaining({\n                source: command.payload.metadata.source,\n              }),\n            }),\n          }),\n        ]),\n      );\n    },\n  );\n\n  test.skip(\n    '[P0][AC2] should persist duplicate linkage to original import context through ConfirmDuplicate command handlers',\n    async ({ request }) => {\n      const command = createConfirmDuplicateCommandEnvelope();\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body).toMatchObject({\n        accepted: true,\n        command_id: command.command_id,\n        mutation_applied: true,\n        event_appended: true,\n        duplicate: expect.objectContaining({\n          document_id: command.payload.document_id,\n          duplicate_of_document_id: command.payload.duplicate_of_document_id,\n          linked_import_command_id: command.payload.correlation.source_import_command_id,\n        }),\n      });\n    },\n  );\n\n  test.skip(\n    '[P1][AC2] should append DuplicateMarked with deterministic correlation fields',\n    async ({ request }) => {\n      const command = createConfirmDuplicateCommandEnvelope();\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body.events).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            type: 'DuplicateMarked',\n            caused_by: command.command_id,\n            data: expect.objectContaining({\n              session_id: command.payload.session_id,\n              document_id: command.payload.document_id,\n              duplicate_of_document_id: command.payload.duplicate_of_document_id,\n              correlation: expect.objectContaining({\n                pair_key: command.payload.correlation.pair_key,\n                source_import_command_id: command.payload.correlation.source_import_command_id,\n                deterministic_key: `${command.payload.session_id}:${command.payload.document_id}:${command.payload.duplicate_of_document_id}`,\n              }),\n            }),\n          }),\n        ]),\n      );\n    },\n  );\n});\n",
      "description": "ATDD API tests for Story 1.3 import + duplicate handling (RED PHASE)",
      "expected_to_fail": true,
      "acceptance_criteria_covered": [
        "Document metadata and blob references persisted via command handlers",
        "DocumentImported appended for accepted import command",
        "Duplicate state persisted and linked to original import context",
        "DuplicateMarked appended with deterministic correlation fields"
      ],
      "priority_coverage": {
        "P0": 3,
        "P1": 1,
        "P2": 0,
        "P3": 0
      }
    }
  ],
  "fixture_needs": [
    "documentImportCommandFactory",
    "documentImportCommandData"
  ],
  "knowledge_fragments_used": [
    "api-request",
    "data-factories",
    "test-quality"
  ],
  "test_count": 4,
  "tdd_phase": "RED",
  "summary": "Generated 4 FAILING API tests for Story 1.3 import and duplicate command contracts"
}
