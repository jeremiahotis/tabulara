{
  "success": true,
  "subprocess": "atdd-api-tests",
  "tests": [
    {
      "file": "tests/api/story-1-2-create-and-pin-sessions-through-command-handlers.spec.ts",
      "content": "import { test, expect } from '@playwright/test';\nimport {\n  createCreateSessionCommandEnvelope,\n  createPinSessionCommandEnvelope,\n} from '../support/fixtures/factories/session-command-factory';\n\ntest.describe('Story 1.2 session command handlers (ATDD RED)', () => {\n  test.skip(\n    '[P0][AC1] should create a session only through CreateSession command handlers',\n    async ({ request }) => {\n      const command = createCreateSessionCommandEnvelope();\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body).toMatchObject({\n        accepted: true,\n        command_id: command.command_id,\n        mutation_applied: true,\n        event_appended: true,\n        session: {\n          project_id: command.payload.project_id,\n          schema_id: command.payload.schema_id,\n          status: 'created',\n        },\n      });\n    },\n  );\n\n  test.skip(\n    '[P0][AC1] should append SessionCreated in audit_log with caused_by linked to command_id',\n    async ({ request }) => {\n      const command = createCreateSessionCommandEnvelope();\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body.audit_log).toEqual(\n        expect.arrayContaining([\n          expect.objectContaining({\n            type: 'SessionCreated',\n            caused_by: command.command_id,\n            data: expect.objectContaining({\n              project_id: command.payload.project_id,\n              schema_id: command.payload.schema_id,\n            }),\n          }),\n        ]),\n      );\n    },\n  );\n\n  test.skip(\n    '[P0][AC2] should pin a session atomically and append SessionPinned in the same transaction',\n    async ({ request }) => {\n      const command = createPinSessionCommandEnvelope({\n        payload: { pinned: true },\n      });\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body).toMatchObject({\n        accepted: true,\n        command_id: command.command_id,\n        transaction: expect.objectContaining({\n          atomic: true,\n        }),\n        session: expect.objectContaining({\n          id: command.payload.session_id,\n          pinned: true,\n        }),\n        events: expect.arrayContaining([\n          expect.objectContaining({\n            type: 'SessionPinned',\n            caused_by: command.command_id,\n          }),\n        ]),\n      });\n    },\n  );\n\n  test.skip(\n    '[P1][AC2] should unpin a session atomically and append SessionUnpinned in the same transaction',\n    async ({ request }) => {\n      const command = createPinSessionCommandEnvelope({\n        payload: { pinned: false },\n      });\n\n      const response = await request.post('/api/v1/commands/dispatch', {\n        data: command,\n      });\n\n      expect(response.status()).toBe(202);\n      const body = await response.json();\n      expect(body).toMatchObject({\n        accepted: true,\n        command_id: command.command_id,\n        transaction: expect.objectContaining({\n          atomic: true,\n        }),\n        session: expect.objectContaining({\n          id: command.payload.session_id,\n          pinned: false,\n        }),\n        events: expect.arrayContaining([\n          expect.objectContaining({\n            type: 'SessionUnpinned',\n            caused_by: command.command_id,\n          }),\n        ]),\n      });\n    },\n  );\n});\n",
      "description": "ATDD API RED tests for Story 1.2 session command handlers",
      "expected_to_fail": true,
      "acceptance_criteria_covered": [
        "CreateSession creates session via command handlers only",
        "SessionCreated appended to audit_log with valid caused_by linkage",
        "PinSession/UnpinSession persist atomically with matching events"
      ],
      "priority_coverage": {
        "P0": 3,
        "P1": 1,
        "P2": 0,
        "P3": 0
      }
    }
  ],
  "fixture_needs": [
    "sessionCommandFactory"
  ],
  "knowledge_fragments_used": [
    "api-request",
    "data-factories",
    "test-levels",
    "test-quality"
  ],
  "test_count": 4,
  "tdd_phase": "RED",
  "summary": "Generated 4 FAILING API tests for Story 1.2"
}
