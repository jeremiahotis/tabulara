name: Branch Protection Drift Check

on:
  workflow_dispatch:
  schedule:
    - cron: "0 14 * * 1-5"

jobs:
  verify-main-protection:
    name: Verify Main Branch Protection
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Verify branch protection invariants
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          response=$(curl -fsSL \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/$REPO/branches/main")

          protected=$(echo "$response" | jq -r '.protected')
          required_checks=$(echo "$response" | jq -r '.protection.required_status_checks.contexts[]')
          enforcement_level=$(echo "$response" | jq -r '.protection.required_status_checks.enforcement_level')

          expected_1="NFR Evidence Pipeline / Collect Raw NFR Evidence"
          expected_2="NFR Evidence Pipeline / Enforce NFR Evidence Gate"

          echo "Current required checks:"
          echo "$required_checks"

          grep -Fx "$expected_1" <<< "$required_checks" >/dev/null || { echo "Missing required check: $expected_1"; exit 1; }
          grep -Fx "$expected_2" <<< "$required_checks" >/dev/null || { echo "Missing required check: $expected_2"; exit 1; }

          [[ "$protected" == "true" ]] || { echo "Drift: main must be protected"; exit 1; }
          [[ "$enforcement_level" == "everyone" ]] || { echo "Drift: required checks enforcement must be everyone"; exit 1; }

          echo "Branch protection invariants are satisfied."
